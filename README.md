# Kontext Super Prompt

**ComfyUIå›¾åƒç¼–è¾‘ä¸æ™ºèƒ½æç¤ºè¯ç”Ÿæˆå·¥å…·é›†** - ä¸“ä¸šçš„å¯è§†åŒ–ç¼–è¾‘ä¸AIå¢å¼ºæç¤ºè¯ç”Ÿæˆ

![Installation](images/instruction.png)

## ğŸ¯ ä¸»è¦èŠ‚ç‚¹

### ğŸ¨ LRPG Canvas  
å¯è§†åŒ–ç”»å¸ƒæ ‡æ³¨å·¥å…·ï¼Œæä¾›ä¸“ä¸šçš„å›¾å±‚ç®¡ç†å’Œç»˜åˆ¶åŠŸèƒ½
- åŸºäºFabric.jsçš„äº¤äº’å¼ç”»å¸ƒç•Œé¢
- æ”¯æŒå¤šç§ç»˜åˆ¶å·¥å…·å’Œå›¾å±‚æ“ä½œï¼ˆç”»ç¬”ã€å½¢çŠ¶ã€æ–‡å­—ã€è£åˆ‡ç­‰ï¼‰
- **ç”»ç¬”ç¾½åŒ–æ•ˆæœ**: é«˜æ–¯åˆ†å¸ƒç®—æ³•å®ç°çš„ä¸“ä¸šè¾¹ç¼˜ç¾½åŒ–ï¼Œ8-15å±‚é€æ˜åº¦æ¸å˜
- **ç²¾ç¡®é¼ æ ‡æ§åˆ¶**: å®Œå…¨ä¿®å¤çš„ç”»ç¬”å·¥å…·ï¼ŒæŒ‰ä½ç»˜åˆ¶ã€é‡Šæ”¾åœæ­¢ï¼Œå“åº”è‡ªç„¶
- è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ–å›¾å±‚æ•°æ®ä¾›ä¸‹æ¸¸èŠ‚ç‚¹ä½¿ç”¨
- å®æ—¶ç”»å¸ƒçŠ¶æ€åŒæ­¥

![LRPG Canvas](images/LRPG_Canvas.png)

### ğŸ¯ Kontext Super Prompt
æ™ºèƒ½æç¤ºè¯ç”Ÿæˆå™¨ï¼Œå°†å›¾å±‚ä¿¡æ¯è½¬æ¢ä¸ºç»“æ„åŒ–ç¼–è¾‘æŒ‡ä»¤
- **äº”ç§ç¼–è¾‘æ¨¡å¼**: å±€éƒ¨ç¼–è¾‘ã€å…¨å±€ç¼–è¾‘ã€æ–‡å­—ç¼–è¾‘ã€ä¸“ä¸šæ“ä½œã€è¿œç¨‹APIã€æœ¬åœ°Ollama
- **40+æ“ä½œæ¨¡æ¿**: æ¶µç›–é¢œè‰²å˜æ¢ã€é£æ ¼é‡æ„ã€æ™ºèƒ½æ›¿æ¢ç­‰
- **çº¦æŸå’Œä¿®é¥°**: è‡ªåŠ¨ç”Ÿæˆè´¨é‡æ§åˆ¶å’Œæ•ˆæœå¢å¼ºæç¤ºè¯
- **AIå¢å¼ºé›†æˆ**: å†…ç½®è¿œç¨‹APIå’Œæœ¬åœ°OllamaæœåŠ¡æ”¯æŒ
- **ç¡®å®šæ€§è¾“å‡º**: ç›¸åŒè¾“å…¥ä¿è¯ç›¸åŒç»“æœ

![Kontext Super Prompt](images/KontextSuperPrompt.png)

#### ğŸ†• æœ€æ–°åŠŸèƒ½äº®ç‚¹

- **ğŸŒ å†…ç½®è¿œç¨‹API**: æ— éœ€é¢å¤–èŠ‚ç‚¹ï¼Œç›´æ¥åœ¨ç¼–è¾‘ç•Œé¢ä½¿ç”¨OpenAIã€Geminiã€DeepSeekç­‰äº‘ç«¯AI
- **ğŸ¦™ é›†æˆOllamaæœåŠ¡**: å†…ç½®æœåŠ¡ç®¡ç†ï¼Œæ”¯æŒä¸€é”®å¯åŠ¨/åœæ­¢ï¼Œè‡ªåŠ¨é‡Šæ”¾GPUå†…å­˜
- **ğŸ”„ åŠ¨æ€æ¨¡å‹è·å–**: è‡ªåŠ¨è·å–æœ€æ–°AIæ¨¡å‹åˆ—è¡¨ï¼Œæ”¯æŒGemini 2.0ã€GPT-4oç­‰æœ€æ–°æ¨¡å‹
- **ğŸ’¬ èŠå¤©å¼äº¤äº’**: APIå’ŒOllamaé€‰é¡¹å¡æ”¯æŒè‡ªç”±è¾“å…¥ï¼Œç±»ä¼¼ChatGPTçš„äº¤äº’ä½“éªŒ
- **âš¡ æ™ºèƒ½èµ„æºç®¡ç†**: è‡ªåŠ¨æ£€æµ‹æœåŠ¡çŠ¶æ€ï¼Œä¸€é”®é‡Šæ”¾GPUæ˜¾å­˜ï¼Œä¼˜åŒ–ç³»ç»Ÿèµ„æº
- **ğŸ¨ ä¿®å¤ç”»ç¬”å·¥å…·**: å®Œå…¨ä¿®å¤LRPG Canvasç”»ç¬”çš„é¼ æ ‡å“åº”é—®é¢˜ï¼Œç¡®ä¿æŒ‰ä½ç»˜åˆ¶ã€é‡Šæ”¾åœæ­¢çš„æ­£å¸¸äº¤äº’
- **âœ¨ æ”¹è¿›ç¾½åŒ–æ•ˆæœ**: ä½¿ç”¨é«˜æ–¯åˆ†å¸ƒç®—æ³•å®ç°çœŸæ­£çš„è¾¹ç¼˜ç¾½åŒ–ï¼Œå¤šå±‚é€æ˜åº¦æ¸å˜ï¼Œåª²ç¾ä¸“ä¸šå›¾åƒç¼–è¾‘è½¯ä»¶

#### ç¼–è¾‘æ¨¡å¼ç•Œé¢å±•ç¤º

**å±€éƒ¨ç¼–è¾‘æ¨¡å¼** - ç²¾ç¡®çš„å¯¹è±¡çº§ç¼–è¾‘æ“ä½œ
![å±€éƒ¨ç¼–è¾‘](images/KontextSuperPrompt1.png)

**å…¨å±€ç¼–è¾‘æ¨¡å¼** - æ•´ä½“å›¾åƒé£æ ¼å’Œæ•ˆæœè°ƒæ•´
![å…¨å±€ç¼–è¾‘](images/KontextSuperPrompt2.png)

**è¿œç¨‹APIæ¨¡å¼** - é›†æˆå¤šç§äº‘ç«¯AIæ¨¡å‹ï¼Œæ”¯æŒåŠ¨æ€æ¨¡å‹é€‰æ‹©
![è¿œç¨‹API](images/KontextSuperPrompt3.png)

**æœ¬åœ°Ollamaæ¨¡å¼** - å†…ç½®æœåŠ¡ç®¡ç†ï¼Œä¸€é”®å¯åŠ¨/åœæ­¢ï¼Œé‡Šæ”¾GPUèµ„æº
![æœ¬åœ°Ollama](images/KontextSuperPrompt4.png)

## ğŸ¤– AIå¢å¼ºèŠ‚ç‚¹

### API Flux Kontext Enhancer
é€šè¿‡APIè°ƒç”¨å¤šç§å¤§æ¨¡å‹å¢å¼ºæç¤ºè¯ç”Ÿæˆ
- **æ”¯æŒå¹³å°**: OpenAI (GPT-4o, o1ç³»åˆ—)ã€DeepSeekã€åƒé—®ã€Gemini (2.0 Flash)ã€æ™ºè°±AIã€Moonshotã€SiliconFlow
- **åŠ¨æ€æ¨¡å‹**: è‡ªåŠ¨è·å–æœ€æ–°æ¨¡å‹åˆ—è¡¨ï¼Œæ”¯æŒæœ€å‰æ²¿AIæ¨¡å‹
- **æˆæœ¬æ§åˆ¶**: å®æ—¶æ˜¾ç¤ºTokenæ¶ˆè€—å’Œè´¹ç”¨ä¼°ç®—
- **æ™ºèƒ½åˆ†æ**: è‡ªåŠ¨ç†è§£ç¼–è¾‘æ„å›¾å¹¶ä¼˜åŒ–æŒ‡ä»¤

![API](images/api.png)

### Ollama Flux Kontext Enhancer  
æœ¬åœ°è¿è¡Œçš„å¤§æ¨¡å‹å¢å¼ºå™¨
- **éšç§ä¿æŠ¤**: å®Œå…¨æœ¬åœ°å¤„ç†ï¼Œæ— éœ€ç½‘ç»œè¿æ¥
- **æ¨¡å‹ç®¡ç†**: æ”¯æŒå¤šç§å¼€æºLLMæ¨¡å‹
- **å‚æ•°å¯è°ƒ**: æ¸©åº¦ã€æœ€å¤§Tokenç­‰å‚æ•°è‡ªå®šä¹‰

![Ollama](images/ollama.png)

### TextGenWebUI Flux Kontext Enhancer
ä¸Text Generation WebUIçš„é›†æˆæ–¹æ¡ˆ
- **æ— ç¼å¯¹æ¥**: ç›´æ¥è°ƒç”¨WebUIæ¥å£
- **æ‰¹é‡å¤„ç†**: æ”¯æŒå¤šä»»åŠ¡å¹¶è¡Œå¤„ç†
- **çŠ¶æ€ç›‘æ§**: å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦

![TextGenWebUI](images/textgen_webui.png)

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€å·¥ä½œæµ
1. æ·»åŠ `ğŸ¨ LRPG Canvas`èŠ‚ç‚¹ï¼Œè¿æ¥å›¾åƒè¾“å…¥
2. åœ¨ç”»å¸ƒä¸­åˆ›å»ºå›¾å±‚å’Œæ ‡æ³¨åŒºåŸŸ
3. è¿æ¥`ğŸ¯ Kontext Super Prompt`èŠ‚ç‚¹ç”Ÿæˆç¼–è¾‘æŒ‡ä»¤
4. å¯é€‰è¿æ¥AIå¢å¼ºèŠ‚ç‚¹è¿›ä¸€æ­¥ä¼˜åŒ–æç¤ºè¯

### èŠ‚ç‚¹è¿æ¥
- **LRPG Canvas**: è¾“å‡º`image`å’Œ`layer_info`
- **Kontext Super Prompt**: æ¥æ”¶`layer_info`å’Œ`image`ï¼Œè¾“å‡º`edited_image`å’Œ`generated_prompt`
- **AIå¢å¼ºå™¨**: æ¥æ”¶`layer_info`å›¾å±‚ä¿¡æ¯ï¼Œè¾“å‡ºAIä¼˜åŒ–çš„ç¼–è¾‘æŒ‡ä»¤

## ğŸ› ï¸ å®‰è£…

### æ–¹å¼ä¸€ï¼šGitå…‹éš†å®‰è£…
```bash
cd ComfyUI/custom_nodes
git clone https://github.com/aiaiaikkk/kontext-super-prompt.git
pip install torch torchvision opencv-python openai
```

### æ–¹å¼äºŒï¼šComfyUI Managerå®‰è£…
1. æ‰“å¼€ComfyUI Manager
2. æœç´¢"kontext-super-prompt"
3. ç‚¹å‡»å®‰è£…å¹¶é‡å¯ComfyUI

### å®‰è£…å®Œæˆ
é‡å¯ComfyUIåï¼Œåœ¨èŠ‚ç‚¹èœå•ä¸­æ‰¾åˆ°"ğŸ¨ LRPG Canvas"åˆ†ç±»

## âš¡ æ ¸å¿ƒç‰¹æ€§

- **ä¸“ä¸šç”»å¸ƒ**: åŸºäºFabric.jsçš„é«˜æ€§èƒ½å›¾å±‚ç¼–è¾‘å™¨
- **æ™ºèƒ½æ¨¡æ¿**: 40+ç§ä¸“ä¸šç¼–è¾‘æ“ä½œæ¨¡æ¿  
- **å¤šAIé›†æˆ**: å†…ç½®è¿œç¨‹APIå’Œæœ¬åœ°OllamaæœåŠ¡æ”¯æŒ
- **åŠ¨æ€æ¨¡å‹é€‰æ‹©**: è‡ªåŠ¨è·å–æœ€æ–°å¯ç”¨AIæ¨¡å‹åˆ—è¡¨
- **æœåŠ¡ç®¡ç†**: ä¸€é”®å¯åŠ¨/åœæ­¢OllamaæœåŠ¡ï¼Œæ™ºèƒ½é‡Šæ”¾GPUèµ„æº
- **æ¨¡å—åŒ–è®¾è®¡**: èŠ‚ç‚¹å¯ç‹¬ç«‹ä½¿ç”¨æˆ–ç»„åˆä½¿ç”¨
- **å®æ—¶åŒæ­¥**: ç”»å¸ƒçŠ¶æ€ä¸èŠ‚ç‚¹æ•°æ®å®æ—¶åŒæ­¥

---

**ç‰ˆæœ¬**: 1.3.3 | **è®¸å¯**: MIT | **ä»“åº“**: https://github.com/aiaiaikkk/kontext-super-prompt

## ğŸ”§ æœ€æ–°æ›´æ–°æ—¥å¿— (v1.3.3)

### ğŸ¨ LRPG Canvas é‡å¤§æ”¹è¿›
- **âœ… ä¿®å¤ç”»ç¬”å·¥å…·**: å®Œå…¨è§£å†³äº†ç”»ç¬”é¼ æ ‡äº‹ä»¶å¤„ç†é—®é¢˜
  - ä¿®å¤äº†"é¼ æ ‡åœ¨ç”»å¸ƒä¸Šå°±ç»˜åˆ¶"çš„å¼‚å¸¸è¡Œä¸º
  - ç¡®ä¿åªæœ‰æŒ‰ä½é¼ æ ‡å·¦é”®æ—¶æ‰ç»˜åˆ¶ï¼Œé‡Šæ”¾æ—¶åœæ­¢
  - åŠ¨æ€ç®¡ç†äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…ä¸Fabric.jså†…ç½®åŠŸèƒ½å†²çª
- **ğŸ¯ çœŸæ­£çš„ç¾½åŒ–æ•ˆæœ**: é‡æ„ç¾½åŒ–ç®—æ³•å®ç°ä¸“ä¸šçº§è¾¹ç¼˜æ•ˆæœ
  - ä½¿ç”¨é«˜æ–¯åˆ†å¸ƒæ•°å­¦æ¨¡å‹è®¡ç®—é€æ˜åº¦è¡°å‡
  - 8-15å±‚é€æ˜åº¦æ¸å˜ï¼Œæä¾›å¹³æ»‘è‡ªç„¶çš„è¾¹ç¼˜æ¨¡ç³Š
  - æ›¿æ¢ç®€å•é˜´å½±æ•ˆæœï¼Œå®ç°çœŸæ­£çš„è¾¹ç¼˜ç¾½åŒ–
  - æ”¯æŒ1-20åƒç´ å¯è°ƒç¾½åŒ–åŠå¾„

---

# Kontext Super Prompt

**ComfyUI Image Editing & Intelligent Prompt Generation Toolkit** - Professional visual editing with AI-enhanced prompt generation

![Installation](images/instruction.png)

## ğŸ¯ Main Nodes

### ğŸ¨ LRPG Canvas  
Visual canvas annotation tool providing professional layer management and drawing capabilities
- Interactive canvas interface based on Fabric.js
- Support for multiple drawing tools and layer operations (brush, shapes, text, cropping, etc.)
- **Brush Feather Effect**: Professional edge feathering with Gaussian distribution algorithm, 8-15 layer transparency gradients
- **Precise Mouse Control**: Completely fixed brush tool with natural hold-to-draw, release-to-stop response
- Automatically generates structured layer data for downstream nodes
- Real-time canvas state synchronization

![LRPG Canvas](images/LRPG_Canvas.png)

### ğŸ¯ Kontext Super Prompt
Intelligent prompt generator that converts layer information into structured editing instructions
- **Five editing modes**: Local editing, global editing, text editing, professional operations, remote API, local Ollama
- **40+ operation templates**: Including color transformation, style reconstruction, intelligent replacement, etc.
- **Constraints and enhancements**: Automatically generates quality control and effect enhancement prompts
- **AI Enhancement Integration**: Built-in remote API and local Ollama service support
- **Deterministic output**: Same input guarantees same results

![Kontext Super Prompt](images/KontextSuperPrompt.png)

#### ğŸ†• Latest Feature Highlights

- **ğŸŒ Built-in Remote API**: No additional nodes needed, directly use OpenAI, Gemini, DeepSeek and other cloud AI in the editing interface
- **ğŸ¦™ Integrated Ollama Service**: Built-in service management with one-click start/stop and automatic GPU memory release
- **ğŸ”„ Dynamic Model Fetching**: Automatically fetch latest AI model lists, supporting Gemini 2.0, GPT-4o and other newest models
- **ğŸ’¬ Chat-like Interaction**: API and Ollama tabs support free input with ChatGPT-like interactive experience
- **âš¡ Smart Resource Management**: Automatic service status detection, one-click GPU memory release, optimized system resources
- **ğŸ¨ Fixed Brush Tool**: Completely fixed LRPG Canvas brush mouse response issues, ensuring proper hold-to-draw, release-to-stop interaction
- **âœ¨ Enhanced Feather Effect**: Gaussian distribution algorithm for true edge feathering with multi-layer transparency gradients, comparable to professional image editing software

#### Editing Mode Interface Showcase

**Local Editing Mode** - Precise object-level editing operations
![Local Editing](images/KontextSuperPrompt1.png)

**Remote API Mode** - Integrated multiple cloud AI models with dynamic model selection
![Remote API](images/KontextSuperPrompt2.png)

**Local Ollama Mode** - Built-in service management with one-click start/stop and GPU resource management
![Local Ollama](images/KontextSuperPrompt3.png)

**Professional Operations Mode** - Advanced image processing and professional editing features
![Professional Operations](images/KontextSuperPrompt4.png)

## ğŸ¤– AI Enhancement Nodes

### API Flux Kontext Enhancer
Enhances prompt generation through API calls to multiple large language models
- **Supported platforms**: OpenAI (GPT-4o, o1 series), DeepSeek, Qianwen, Gemini (2.0 Flash), Zhipu AI, Moonshot, SiliconFlow
- **Dynamic Models**: Automatically fetch latest model lists, supporting cutting-edge AI models
- **Cost control**: Real-time display of token consumption and cost estimation
- **Intelligent analysis**: Automatically understands editing intent and optimizes instructions

![API](images/api.png)

### Ollama Flux Kontext Enhancer  
Local-running large language model enhancer
- **Privacy protection**: Completely local processing, no network connection required
- **Model management**: Support for various open-source LLM models
- **Adjustable parameters**: Customizable temperature, max tokens, and other parameters

![Ollama](images/ollama.png)

### TextGenWebUI Flux Kontext Enhancer
Integration solution with Text Generation WebUI
- **Seamless integration**: Direct WebUI interface calls
- **Batch processing**: Support for multi-task parallel processing
- **Status monitoring**: Real-time display of processing progress

![TextGenWebUI](images/textgen_webui.png)

## ğŸ“‹ Usage

### Basic Workflow
1. Add `ğŸ¨ LRPG Canvas` node and connect image input
2. Create layers and annotation areas in the canvas
3. Connect `ğŸ¯ Kontext Super Prompt` node to generate editing instructions
4. Optionally connect AI enhancement nodes for further prompt optimization

### Node Connections
- **LRPG Canvas**: Outputs `image` and `layer_info`
- **Kontext Super Prompt**: Receives `layer_info` and `image`, outputs `edited_image` and `generated_prompt`
- **AI Enhancers**: Receive `layer_info` layer information, output AI-optimized editing instructions

## ğŸ› ï¸ Installation

### Method 1: Git Clone Installation
```bash
cd ComfyUI/custom_nodes
git clone https://github.com/aiaiaikkk/kontext-super-prompt.git
pip install torch torchvision opencv-python openai
```

### Method 2: ComfyUI Manager Installation
1. Open ComfyUI Manager
2. Search for "kontext-super-prompt"
3. Click install and restart ComfyUI

### Installation Complete
After restarting ComfyUI, find the "ğŸ¨ LRPG Canvas" category in the node menu

## âš¡ Core Features

- **Professional Canvas**: High-performance layer editor based on Fabric.js
- **Intelligent Templates**: 40+ professional editing operation templates
- **Multi-AI Integration**: Built-in remote API and local Ollama service support
- **Dynamic Model Selection**: Automatically fetches latest available AI model lists
- **Service Management**: One-click Ollama service start/stop with intelligent GPU resource management
- **Modular Design**: Nodes can be used independently or in combination
- **Real-time Sync**: Canvas state synchronizes with node data in real-time

---

**Version**: 1.3.3 | **License**: MIT | **Repository**: https://github.com/aiaiaikkk/kontext-super-prompt

## ğŸ”§ Latest Update Log (v1.3.3)

### ğŸ¨ LRPG Canvas Major Improvements
- **âœ… Fixed Brush Tool**: Completely resolved brush mouse event handling issues
  - Fixed abnormal "drawing when mouse is on canvas" behavior
  - Ensures drawing only occurs when holding left mouse button, stops when released
  - Dynamic event listener management to avoid conflicts with Fabric.js built-in functionality
- **ğŸ¯ True Feather Effect**: Reconstructed feathering algorithm for professional-grade edge effects
  - Uses Gaussian distribution mathematical model for transparency decay calculation
  - 8-15 layer transparency gradients providing smooth and natural edge blur
  - Replaced simple shadow effects with true edge feathering
  - Supports adjustable feather radius from 1-20 pixels